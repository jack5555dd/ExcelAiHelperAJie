# Excel AIåŠ©æ‰‹åŸºæœ¬åŠŸèƒ½å®Œå–„æ€»ç»“

**æ—¥æœŸ**: 2025-07-31 17:15  
**å¼€å‘äºº**: Kiro AI Assistant  
**åŠŸèƒ½**: å®Œå–„ExcelåŸºæœ¬æ“ä½œåŠŸèƒ½

## ğŸ¯ é—®é¢˜åˆ†æ

### å‘ç°çš„é—®é¢˜
1. **GetRangeDataAsync RuntimeBinderException**: å•å…ƒæ ¼æ•°æ®è·å–æ—¶ç±»å‹è½¬æ¢é”™è¯¯
2. **ç¼ºå°‘åŸºæœ¬ExcelåŠŸèƒ½**: åˆ é™¤å†…å®¹ã€èƒŒæ™¯è‰²ã€å­—ä½“æ ·å¼ç­‰åŸºæœ¬åŠŸèƒ½æœªå®ç°
3. **ä½ç½®å®šä½éœ€è¦ç»Ÿä¸€**: æ‰€æœ‰åŠŸèƒ½éƒ½éœ€è¦æ”¯æŒåæ ‡å®šä½å’Œé€‰åŒºå®šä½

### ç”¨æˆ·éœ€æ±‚
ç”¨æˆ·éœ€è¦å®Œæ•´çš„ExcelåŸºæœ¬æ“ä½œåŠŸèƒ½ï¼š
- åˆ é™¤å•å…ƒæ ¼å†…å®¹
- è®¾ç½®èƒŒæ™¯é¢œè‰²
- è®¾ç½®å­—ä½“æ ·å¼ï¼ˆé¢œè‰²ã€ç²—ä½“ã€æ–œä½“ç­‰ï¼‰
- æ’å…¥/åˆ é™¤è¡Œåˆ—
- æ‰€æœ‰åŠŸèƒ½éƒ½æ”¯æŒåæ ‡å®šä½å’Œé€‰åŒºå®šä½

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤GetRangeDataAsyncæ–¹æ³•

#### é—®é¢˜æ ¹å› 
å½“rangeåªæœ‰ä¸€ä¸ªå•å…ƒæ ¼æ—¶ï¼Œ`range.Value2`è¿”å›å•ä¸ªå€¼è€Œä¸æ˜¯äºŒç»´æ•°ç»„ï¼Œå¯¼è‡´ç±»å‹è½¬æ¢å¼‚å¸¸ã€‚

#### ä¿®å¤æ–¹æ¡ˆ
```csharp
public async Task<DataTable> GetRangeDataAsync(Excel.Range range)
{
    object rangeValue = range.Value2;
    int rows = range.Rows.Count;
    int cols = range.Columns.Count;
    
    // Handle single cell vs multi-cell range
    if (rows == 1 && cols == 1)
    {
        // Single cell - rangeValue is a single object
        var row = data.NewRow();
        row[0] = rangeValue ?? DBNull.Value;
        data.Rows.Add(row);
    }
    else
    {
        // Multi-cell range - rangeValue is object[,]
        object[,] values = rangeValue as object[,];
        // Process 2D array...
    }
}
```

### 2. æ–°å¢ExcelåŸºæœ¬åŠŸèƒ½

#### 2.1 å†…å®¹æ“ä½œåŠŸèƒ½
```csharp
// æ¸…é™¤å†…å®¹
public async Task ClearRangeContentAsync(Excel.Range range)
{
    range.ClearContents();
}
```

#### 2.2 æ ·å¼è®¾ç½®åŠŸèƒ½
```csharp
// èƒŒæ™¯é¢œè‰²
public async Task SetBackgroundColorAsync(Excel.Range range, string color)
{
    System.Drawing.Color rgbColor = ParseColor(color);
    range.Interior.Color = System.Drawing.ColorTranslator.ToOle(rgbColor);
}

// å­—ä½“é¢œè‰²
public async Task SetFontColorAsync(Excel.Range range, string color)
{
    System.Drawing.Color rgbColor = ParseColor(color);
    range.Font.Color = System.Drawing.ColorTranslator.ToOle(rgbColor);
}

// å­—ä½“æ ·å¼
public async Task SetFontStyleAsync(Excel.Range range, bool? bold = null, 
    bool? italic = null, bool? underline = null, int? fontSize = null, string fontName = null)
{
    if (bold.HasValue) range.Font.Bold = bold.Value;
    if (italic.HasValue) range.Font.Italic = italic.Value;
    if (underline.HasValue) range.Font.Underline = underline.Value;
    if (fontSize.HasValue) range.Font.Size = fontSize.Value;
    if (!string.IsNullOrEmpty(fontName)) range.Font.Name = fontName;
}
```

#### 2.3 è¡Œåˆ—æ“ä½œåŠŸèƒ½
```csharp
// åˆ é™¤è¡Œ
public async Task DeleteRowsAsync(Excel.Range range)
{
    range.EntireRow.Delete();
}

// åˆ é™¤åˆ—
public async Task DeleteColumnsAsync(Excel.Range range)
{
    range.EntireColumn.Delete();
}

// æ’å…¥è¡Œ
public async Task InsertRowsAsync(Excel.Range range)
{
    range.EntireRow.Insert();
}

// æ’å…¥åˆ—
public async Task InsertColumnsAsync(Excel.Range range)
{
    range.EntireColumn.Insert();
}
```

#### 2.4 é¢œè‰²è§£æåŠŸèƒ½
```csharp
private System.Drawing.Color ParseColor(string colorString)
{
    // æ”¯æŒåå…­è¿›åˆ¶é¢œè‰² (#FF0000)
    if (colorString.StartsWith("#"))
    {
        return System.Drawing.ColorTranslator.FromHtml(colorString);
    }
    
    // æ”¯æŒé¢œè‰²åç§° (red, blue, greenç­‰)
    switch (colorString.ToLower())
    {
        case "red": return System.Drawing.Color.Red;
        case "green": return System.Drawing.Color.Green;
        case "blue": return System.Drawing.Color.Blue;
        // ... æ›´å¤šé¢œè‰²æ˜ å°„
    }
}
```

### 3. æŒ‡ä»¤å¤„ç†å¢å¼º

#### æ–°å¢æŒ‡ä»¤ç±»å‹
```csharp
public enum InstructionType
{
    // ç°æœ‰ç±»å‹...
    ClearContent,        // æ¸…é™¤å†…å®¹
    // SetCellStyleå·²å­˜åœ¨ï¼Œå¢å¼ºå‚æ•°æ”¯æŒ
}
```

#### æ ·å¼æŒ‡ä»¤å¤„ç†
```csharp
case InstructionType.SetCellStyle:
    return await HandleSetCellStyleAsync(targetRange, instruction);

case InstructionType.ClearContent:
    await ClearRangeContentAsync(targetRange);
    return $"âœ“ Cleared content in {targetRange.Address}";
```

#### å¤åˆæ ·å¼å¤„ç†
```csharp
private async Task<string> HandleSetCellStyleAsync(Excel.Range targetRange, Instruction instruction)
{
    var results = new List<string>();
    
    // èƒŒæ™¯é¢œè‰²
    if (instruction.Parameters.TryGetValue("backgroundColor", out object bgColor))
        await SetBackgroundColorAsync(targetRange, bgColor as string);
    
    // å­—ä½“é¢œè‰²
    if (instruction.Parameters.TryGetValue("fontColor", out object fontColor))
        await SetFontColorAsync(targetRange, fontColor as string);
    
    // å­—ä½“æ ·å¼
    bool? bold = GetBoolParameter(instruction, "bold");
    bool? italic = GetBoolParameter(instruction, "italic");
    // ... å¤„ç†å…¶ä»–æ ·å¼å‚æ•°
    
    await SetFontStyleAsync(targetRange, bold, italic, underline, fontSize, fontName);
    
    return $"âœ“ Set {string.Join(", ", results)} in {targetRange.Address}";
}
```

### 4. AIæç¤ºä¼˜åŒ–

#### æ–°å¢æ ·å¼æŒ‡å¯¼
```
Style Guidelines:
- For SetCellStyle: backgroundColor (hex like #FF0000 or name like 'red')
- fontColor (hex like #0000FF or name like 'blue')
- bold, italic, underline (true/false)
- fontSize (number like 12, 14, 16)
- fontName (string like 'Arial', 'Times New Roman')
- For ClearContent: use when user wants to delete/clear cell content
```

#### æ›´æ–°æŒ‡ä»¤ç±»å‹è¯´æ˜
```
Available instruction types:
- SetCellStyle: Sets cell style (backgroundColor, fontColor, bold, italic, underline, fontSize, fontName)
- ClearContent: Clears cell content
- DeleteRows: Deletes rows
- DeleteColumns: Deletes columns
- InsertRows: Inserts rows
- InsertColumns: Inserts columns
```

## âœ… å®ç°çš„åŠŸèƒ½

### 1. æ•°æ®è·å–ä¿®å¤
- [x] **å•å…ƒæ ¼æ•°æ®è·å–**: ä¿®å¤å•å…ƒæ ¼vså¤šå•å…ƒæ ¼çš„ç±»å‹è½¬æ¢é—®é¢˜
- [x] **å…¼å®¹æ€§å¤„ç†**: åŒæ—¶æ”¯æŒå•ä¸ªå€¼å’ŒäºŒç»´æ•°ç»„
- [x] **é”™è¯¯å¤„ç†**: æ”¹è¿›å¼‚å¸¸å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯

### 2. å†…å®¹æ“ä½œåŠŸèƒ½
- [x] **æ¸…é™¤å†…å®¹**: ClearContentæŒ‡ä»¤æ¸…é™¤å•å…ƒæ ¼å†…å®¹
- [x] **ä½ç½®å®šä½**: æ”¯æŒåæ ‡å®šä½å’Œé€‰åŒºå®šä½
- [x] **æ‰¹é‡æ“ä½œ**: æ”¯æŒé€‰ä¸­å¤šä¸ªå•å…ƒæ ¼çš„æ‰¹é‡æ¸…é™¤

### 3. æ ·å¼è®¾ç½®åŠŸèƒ½
- [x] **èƒŒæ™¯é¢œè‰²**: æ”¯æŒåå…­è¿›åˆ¶å’Œé¢œè‰²åç§°
- [x] **å­—ä½“é¢œè‰²**: æ”¯æŒå¤šç§é¢œè‰²æ ¼å¼
- [x] **å­—ä½“æ ·å¼**: ç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ã€å­—å·ã€å­—ä½“åç§°
- [x] **å¤åˆæ ·å¼**: ä¸€æ¬¡æŒ‡ä»¤è®¾ç½®å¤šä¸ªæ ·å¼å±æ€§
- [x] **é¢œè‰²è§£æ**: æ™ºèƒ½é¢œè‰²å­—ç¬¦ä¸²è§£æ

### 4. è¡Œåˆ—æ“ä½œåŠŸèƒ½
- [x] **åˆ é™¤è¡Œ**: DeleteRowsæŒ‡ä»¤åˆ é™¤æ•´è¡Œ
- [x] **åˆ é™¤åˆ—**: DeleteColumnsæŒ‡ä»¤åˆ é™¤æ•´åˆ—
- [x] **æ’å…¥è¡Œ**: InsertRowsæŒ‡ä»¤æ’å…¥æ–°è¡Œ
- [x] **æ’å…¥åˆ—**: InsertColumnsæŒ‡ä»¤æ’å…¥æ–°åˆ—
- [x] **æ™ºèƒ½å®šä½**: åŸºäºé€‰åŒºæˆ–åæ ‡è¿›è¡Œæ“ä½œ

### 5. ç»Ÿä¸€ä½ç½®å®šä½
- [x] **åæ ‡å®šä½**: "ç»™C1çš„èƒŒæ™¯é¢œè‰²æ”¹ä¸ºçº¢è‰²"
- [x] **é€‰åŒºå®šä½**: "åˆ é™¤å½“å‰é€‰åŒºå†…å®¹"
- [x] **æ™ºèƒ½å›é€€**: è§£æå¤±è´¥æ—¶çš„è‡ªåŠ¨å›é€€æœºåˆ¶
- [x] **ä¸€è‡´æ€§**: æ‰€æœ‰åŠŸèƒ½éƒ½ä½¿ç”¨ç›¸åŒçš„å®šä½é€»è¾‘

## ğŸ§ª æ”¯æŒçš„æ“ä½œç¤ºä¾‹

### æ ·å¼è®¾ç½®
```
ç”¨æˆ·: "ç»™C1çš„èƒŒæ™¯é¢œè‰²æ”¹ä¸ºçº¢è‰²"
AIç†è§£: SetCellStyle, targetRange="C1", backgroundColor="#FF0000"
æ‰§è¡Œç»“æœ: âœ“ Set background color to red in $C$1

ç”¨æˆ·: "æŠŠå½“å‰é€‰åŒºçš„å­—ä½“è®¾ä¸ºç²—ä½“è“è‰²"
AIç†è§£: SetCellStyle, fontColor="blue", bold=true
æ‰§è¡Œç»“æœ: âœ“ Set font color to blue, font style (bold: true) in $A$1
```

### å†…å®¹æ“ä½œ
```
ç”¨æˆ·: "åˆ é™¤å½“å‰é€‰åŒºå†…å®¹"
AIç†è§£: ClearContent, targetRange=å½“å‰é€‰åŒº
æ‰§è¡Œç»“æœ: âœ“ Cleared content in $H$17

ç”¨æˆ·: "æ¸…ç©ºA1åˆ°C3çš„å†…å®¹"
AIç†è§£: ClearContent, targetRange="A1:C3"
æ‰§è¡Œç»“æœ: âœ“ Cleared content in $A$1:$C$3
```

### è¡Œåˆ—æ“ä½œ
```
ç”¨æˆ·: "åˆ é™¤ç¬¬3è¡Œ"
AIç†è§£: DeleteRows, targetRange="3:3"
æ‰§è¡Œç»“æœ: âœ“ Deleted rows in $3:$3

ç”¨æˆ·: "åœ¨å½“å‰ä½ç½®æ’å…¥ä¸€åˆ—"
AIç†è§£: InsertColumns, targetRange=å½“å‰é€‰åŒº
æ‰§è¡Œç»“æœ: âœ“ Inserted columns at $C$1
```

## ğŸ“‹ æŠ€æœ¯å®ç°ç»†èŠ‚

### é¢œè‰²å¤„ç†
- **åå…­è¿›åˆ¶**: #FF0000, #00FF00, #0000FF
- **é¢œè‰²åç§°**: red, green, blue, yellow, orange, purple, pink, gray, black, white
- **å¤§å°å†™ä¸æ•æ„Ÿ**: Red, RED, redéƒ½æ”¯æŒ
- **é»˜è®¤å›é€€**: æ— æ•ˆé¢œè‰²é»˜è®¤ä¸ºé»‘è‰²

### æ ·å¼å‚æ•°
- **backgroundColor**: å­—ç¬¦ä¸²ï¼Œåå…­è¿›åˆ¶æˆ–é¢œè‰²åç§°
- **fontColor**: å­—ç¬¦ä¸²ï¼Œåå…­è¿›åˆ¶æˆ–é¢œè‰²åç§°
- **bold**: å¸ƒå°”å€¼ï¼Œtrue/false
- **italic**: å¸ƒå°”å€¼ï¼Œtrue/false
- **underline**: å¸ƒå°”å€¼ï¼Œtrue/false
- **fontSize**: æ•´æ•°ï¼Œå¦‚12, 14, 16
- **fontName**: å­—ç¬¦ä¸²ï¼Œå¦‚"Arial", "Times New Roman"

### ä½ç½®å®šä½ç»Ÿä¸€
æ‰€æœ‰æ–°åŠŸèƒ½éƒ½ä½¿ç”¨`GetTargetRangeAsync`æ–¹æ³•ï¼š
1. è§£æå…·ä½“åæ ‡ï¼ˆC1, A1:C3ï¼‰
2. è¯†åˆ«è¯­ä¹‰è¡¨è¾¾ï¼ˆcurrent, selectedï¼‰
3. æ™ºèƒ½å›é€€åˆ°é€‰ä¸­åŒºåŸŸ
4. æœ€ç»ˆå›é€€åˆ°A1å•å…ƒæ ¼

## ğŸ” è°ƒè¯•ä¿¡æ¯

### æ ·å¼è®¾ç½®æ—¥å¿—
```
Target range resolved to: $C$1 for instruction: Set cell C1 background color to red
âœ“ Set background color to red in $C$1
```

### å†…å®¹æ¸…é™¤æ—¥å¿—
```
Target range resolved to: $H$17 for instruction: Clear current selection content
âœ“ Cleared content in $H$17
```

## ğŸ“ æ€»ç»“

é€šè¿‡å®Œå–„ExcelåŸºæœ¬åŠŸèƒ½ï¼š

1. **ä¿®å¤äº†æ•°æ®è·å–é—®é¢˜**: è§£å†³å•å…ƒæ ¼æ•°æ®ç±»å‹è½¬æ¢å¼‚å¸¸
2. **å®ç°äº†å®Œæ•´çš„æ ·å¼åŠŸèƒ½**: èƒŒæ™¯è‰²ã€å­—ä½“è‰²ã€å­—ä½“æ ·å¼ç­‰
3. **æ·»åŠ äº†å†…å®¹æ“ä½œåŠŸèƒ½**: æ¸…é™¤å†…å®¹ã€è¡Œåˆ—æ“ä½œç­‰
4. **ç»Ÿä¸€äº†ä½ç½®å®šä½**: æ‰€æœ‰åŠŸèƒ½éƒ½æ”¯æŒåæ ‡å’Œé€‰åŒºå®šä½
5. **æå‡äº†ç”¨æˆ·ä½“éªŒ**: æ”¯æŒè‡ªç„¶è¯­è¨€æè¿°å„ç§Excelæ“ä½œ

ç°åœ¨ç”¨æˆ·å¯ä»¥ä½¿ç”¨è‡ªç„¶è¯­è¨€è¿›è¡Œå„ç§ExcelåŸºæœ¬æ“ä½œï¼š
- "ç»™C1çš„èƒŒæ™¯é¢œè‰²æ”¹ä¸ºçº¢è‰²" âœ“
- "åˆ é™¤å½“å‰é€‰åŒºå†…å®¹" âœ“
- "æŠŠé€‰ä¸­çš„æ–‡å­—è®¾ä¸ºç²—ä½“" âœ“
- "åœ¨è¿™é‡Œæ’å…¥ä¸€è¡Œ" âœ“
- "åˆ é™¤ç¬¬3åˆ—" âœ“

ç³»ç»Ÿä¼šæ™ºèƒ½ç†è§£ç”¨æˆ·æ„å›¾å¹¶æ­£ç¡®æ‰§è¡Œç›¸åº”çš„Excelæ“ä½œï¼

## ğŸš€ ä¸‹ä¸€æ­¥æ‰©å±•å»ºè®®

1. **é«˜çº§æ ¼å¼åŠŸèƒ½**: è¾¹æ¡†è®¾ç½®ã€å¯¹é½æ–¹å¼ã€æ•°å­—æ ¼å¼
2. **æ•°æ®æ“ä½œ**: æ’åºã€ç­›é€‰ã€æŸ¥æ‰¾æ›¿æ¢
3. **å›¾è¡¨åŠŸèƒ½**: è‡ªåŠ¨ç”Ÿæˆå„ç§ç±»å‹çš„å›¾è¡¨
4. **æ¡ä»¶æ ¼å¼**: åŸºäºæ¡ä»¶çš„è‡ªåŠ¨æ ¼å¼è®¾ç½®
5. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ›´å¤æ‚çš„æ‰¹é‡æ•°æ®å¤„ç†